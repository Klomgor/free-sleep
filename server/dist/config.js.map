{"version":3,"file":"config.js","sources":["config.ts"],"sourceRoot":"/","sourcesContent":["import { existsSync, readFileSync } from 'fs';\nimport logger from './logger.js';\n\n\nfunction checkIfDacSockPathConfigured(): string | undefined {\n  try {\n    // Check if the file exists\n    const filePath = '/persistent/free-sleep-data/dac_sock_path.txt';\n    if (!existsSync(filePath)) {\n      logger.debug(`dac.sock path not configured, defaulting to pod 3 path...`);\n      return;\n    }\n\n    const data = readFileSync(filePath, 'utf8');\n\n    // Remove all newline characters\n    return data.replace(/\\r?\\n/g, '');\n  } catch (error) {\n    logger.error(error);\n  }\n}\n\n\ntype FirmwareVersion = 'pod3FirmwareReset' | 'pod4FirmwareReset' | 'remoteDevMode';\n\ninterface FirmwareConfig {\n  dacLocation: string;\n}\n\nconst FIRMWARE_MAP: Record<FirmwareVersion, FirmwareConfig> = {\n  remoteDevMode: {\n    dacLocation: `${process.env.DATA_FOLDER}/dac.sock`,\n  },\n  pod3FirmwareReset: {\n    dacLocation: '/deviceinfo/dac.sock',\n  },\n  pod4FirmwareReset: {\n    dacLocation: '/persistent/deviceinfo/dac.sock',\n  },\n};\n\n\nclass Config {\n  // eslint-disable-next-line no-use-before-define\n  private static instance: Config;\n  public dbFolder: string;\n  public lowDbFolder: string;\n  public remoteDevMode: boolean;\n  public dacSockPath: string;\n\n  private constructor() {\n    if (!process.env.DATA_FOLDER || !process.env.ENV) {\n      throw new Error('Missing DATA_FOLDER || ENV in env');\n    }\n    this.remoteDevMode = process.env.ENV === 'local';\n    this.dacSockPath = this.detectSockPath();\n    this.dbFolder = process.env.DATA_FOLDER;\n    this.lowDbFolder = `${this.dbFolder}lowdb/`;\n  }\n\n\n  private detectSockPath(): string {\n    const dacSockPath = checkIfDacSockPathConfigured();\n\n    if (dacSockPath) {\n      logger.debug(`'Custom dac.sock path configured, using ${dacSockPath}`);\n      return dacSockPath;\n    } else if (!this.remoteDevMode){\n      logger.debug('No dac.sock path configured, defaulting to pod 3 path');\n      return FIRMWARE_MAP.pod3FirmwareReset.dacLocation;\n\n    } else if (this.remoteDevMode) {\n      return FIRMWARE_MAP.remoteDevMode.dacLocation;\n    } else {\n      throw new Error('Error - Did not detect device firmware');\n    }\n  }\n\n  public static getInstance(): Config {\n    if (!Config.instance) {\n      Config.instance = new Config();\n    }\n    return Config.instance;\n  }\n}\n\nexport default Config.getInstance();\n"],"names":[],"mappings":";;AAAA,OAAO,EAAE,UAAU,EAAE,YAAY,EAAE,MAAM,IAAI,CAAC;AAC9C,OAAO,MAAM,MAAM,aAAa,CAAC;AAGjC,SAAS,4BAA4B;IACnC,IAAI,CAAC;QACH,2BAA2B;QAC3B,MAAM,QAAQ,GAAG,+CAA+C,CAAC;QACjE,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC;YAC1B,MAAM,CAAC,KAAK,CAAC,2DAA2D,CAAC,CAAC;YAC1E,OAAO;QACT,CAAC;QAED,MAAM,IAAI,GAAG,YAAY,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAE5C,gCAAgC;QAChC,OAAO,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;IACpC,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;IACtB,CAAC;AACH,CAAC;AASD,MAAM,YAAY,GAA4C;IAC5D,aAAa,EAAE;QACb,WAAW,EAAE,GAAG,OAAO,CAAC,GAAG,CAAC,WAAW,WAAW;KACnD;IACD,iBAAiB,EAAE;QACjB,WAAW,EAAE,sBAAsB;KACpC;IACD,iBAAiB,EAAE;QACjB,WAAW,EAAE,iCAAiC;KAC/C;CACF,CAAC;AAGF,MAAM,MAAM;IACV,gDAAgD;IACxC,MAAM,CAAC,QAAQ,CAAS;IACzB,QAAQ,CAAS;IACjB,WAAW,CAAS;IACpB,aAAa,CAAU;IACvB,WAAW,CAAS;IAE3B;QACE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,WAAW,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC;YACjD,MAAM,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC;QACvD,CAAC;QACD,IAAI,CAAC,aAAa,GAAG,OAAO,CAAC,GAAG,CAAC,GAAG,KAAK,OAAO,CAAC;QACjD,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,cAAc,EAAE,CAAC;QACzC,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC;QACxC,IAAI,CAAC,WAAW,GAAG,GAAG,IAAI,CAAC,QAAQ,QAAQ,CAAC;IAC9C,CAAC;IAGO,cAAc;QACpB,MAAM,WAAW,GAAG,4BAA4B,EAAE,CAAC;QAEnD,IAAI,WAAW,EAAE,CAAC;YAChB,MAAM,CAAC,KAAK,CAAC,2CAA2C,WAAW,EAAE,CAAC,CAAC;YACvE,OAAO,WAAW,CAAC;QACrB,CAAC;aAAM,IAAI,CAAC,IAAI,CAAC,aAAa,EAAC,CAAC;YAC9B,MAAM,CAAC,KAAK,CAAC,uDAAuD,CAAC,CAAC;YACtE,OAAO,YAAY,CAAC,iBAAiB,CAAC,WAAW,CAAC;QAEpD,CAAC;aAAM,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;YAC9B,OAAO,YAAY,CAAC,aAAa,CAAC,WAAW,CAAC;QAChD,CAAC;aAAM,CAAC;YACN,MAAM,IAAI,KAAK,CAAC,wCAAwC,CAAC,CAAC;QAC5D,CAAC;IACH,CAAC;IAEM,MAAM,CAAC,WAAW;QACvB,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC;YACrB,MAAM,CAAC,QAAQ,GAAG,IAAI,MAAM,EAAE,CAAC;QACjC,CAAC;QACD,OAAO,MAAM,CAAC,QAAQ,CAAC;IACzB,CAAC;CACF;AAED,eAAe,MAAM,CAAC,WAAW,EAAE,CAAC","debug_id":"7f9db221-cffe-506b-9119-22d62709d73e"}