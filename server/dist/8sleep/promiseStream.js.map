{"version":3,"file":"promiseStream.js","sources":["8sleep/promiseStream.ts"],"sourceRoot":"/","sourcesContent":["/* eslint-disable @typescript-eslint/prefer-optional-chain */\n// @ts-nocheck\n// This was copied straight from the @eight/promise-streams package\n// I was concerned they might remove the packages from npm if they want to prevent people from researching free-sleep\n//\n// So I made a copy of their packages here, so we don't depend on being able to install\n// @eight/promises && @eight/promise-streams\n\nimport { toPromise } from './promises.js';\nimport { Readable, Writable, Duplex } from 'stream';\n\nclass StreamReader {\n  constructor(stream, errorTransform) {\n    this.stream = stream;\n    this.errorTransform = errorTransform;\n    this.eos = false;\n    this.reader = true;\n    if (!stream.readable)\n      throw new Error('stream is not readable');\n    stream.on('error', this.onError.bind(this));\n    stream.on('end', this.onEnd.bind(this));\n    stream.on('readable', this.onReadable.bind(this));\n  }\n\n  resolve(res) {\n    if (this.promised !== undefined) {\n      const [resolve] = this.promised;\n      this.promised = undefined;\n      resolve(res);\n    }\n  }\n\n  onEnd() {\n    this.eos = true;\n    this.resolve(undefined);\n  }\n\n  onReadable() {\n    if (this.promised !== undefined) {\n      const read = this.stream.read();\n      // tslint:disable-next-line:no-null-keyword\n      if (read === null) {\n        this.onEnd();\n      } else {\n        this.resolve(read);\n      }\n    }\n  }\n\n  onError(err) {\n    this.eos = true;\n    const error = this.errorTransform ? this.errorTransform(err) : err;\n    if (this.promised !== undefined) {\n      const [, reject] = this.promised;\n      this.promised = undefined;\n      reject(error);\n    } else {\n      this.error = error;\n    }\n  }\n\n  read() {\n    if (this.promised !== undefined)\n      throw new Error('cannot invoke read concurrently (missing await ?)');\n    if (this.error !== undefined) {\n      const ret = Promise.reject(this.error);\n      this.error = undefined;\n      return ret;\n    }\n    if (this.eos)\n      return Promise.resolve(undefined);\n    const read = this.stream.read();\n    // tslint:disable-next-line:no-null-keyword\n    if (read !== null)\n      return Promise.resolve(read);\n    return new Promise((resolve, reject) => {\n      this.promised = [resolve, reject];\n    });\n  }\n\n  static isReader(obj) {\n    return !!obj && !!obj.reader;\n  }\n}\n\nfunction isReadable(stream) {\n  return !!(stream && stream.readable);\n}\n\nfunction isWritable(stream) {\n  return !!(stream && stream.writable);\n}\n\n\nclass StreamWriter {\n  constructor(stream, errorTransform) {\n    this.stream = stream;\n    this.errorTransform = errorTransform;\n    this.reader = true;\n    if (!stream.writable)\n      throw new Error('stream is not writable');\n  }\n\n  async write(data) {\n    try {\n      await toPromise(cb => this.stream.write(data, cb));\n    } catch (err) {\n      const error = this.errorTransform ? this.errorTransform(err) : err;\n      this.stream.emit('error', error);\n      throw error;\n    }\n  }\n\n  static isWriter(obj) {\n    return !!obj && !!obj.reader;\n  }\n}\n\nclass CombinedStream {\n  constructor(readStream, writeStream) {\n    this.readStream = readStream;\n    this.writeStream = writeStream;\n  }\n\n  read() {\n    return this.readStream.read();\n  }\n\n  write(chunk) {\n    return this.writeStream.write(chunk);\n  }\n}\n\nclass ReadableWrapper extends Readable {\n  constructor(stream) {\n    super({ objectMode: true });\n    this.stream = stream;\n  }\n\n  async _read() {\n    try {\n      let read;\n      while ((read = (await this.stream.read()) && this.push(read)))\n        ;\n      if (!read) {\n        // tslint:disable-next-line:no-null-keyword\n        this.push(null);\n      }\n    } catch (error) {\n      this.emit('error', error);\n    }\n  }\n}\n\nclass WritableWrapper extends Writable {\n  constructor(stream) {\n    super({ objectMode: true });\n    this.stream = stream;\n  }\n\n  async _write(chunk, enc, cb) {\n    try {\n      await this.stream.write(chunk);\n    } catch (error) {\n      cb(error);\n    }\n  }\n}\n\nclass DuplexWrapper extends Duplex {\n  constructor(stream) {\n    super({ objectMode: true });\n    this.readableStream = new ReadableWrapper(stream);\n    this.writableStream = new WritableWrapper(stream);\n  }\n\n  _read() {\n    this.readableStream._read();\n  }\n\n  _write(chunk, enc, cb) {\n    this.writableStream._write(chunk, enc, cb);\n  }\n}\n\nexport interface PromiseWriteStream<T = any> {\n  write(data: T): Promise<void>;\n}\n\nexport interface PromiseReadStream<T = any> {\n  read(): Promise<T | undefined>;\n}\n\nexport declare type PromiseStream<T = any> = PromiseReadStream<T> & PromiseWriteStream<T>;\n\nexport class PromiseStreams {\n  static toPromise(stream, errorTransform) {\n    const reader = isReadable(stream) ? new StreamReader(stream, errorTransform) : undefined;\n    const writer = isWritable(stream) ? new StreamWriter(stream, errorTransform) : undefined;\n    if (!reader && !writer)\n      throw new Error('not a stream');\n    if (reader && writer)\n      return new CombinedStream(reader, writer);\n    return reader ? reader : writer;\n  }\n\n  static toStream(promiseStream) {\n    const readable = !!promiseStream.read;\n    const writable = !!promiseStream.write;\n    if (readable && writable)\n      return new DuplexWrapper(promiseStream);\n    if (readable)\n      return new ReadableWrapper(promiseStream);\n    if (writable)\n      return new WritableWrapper(promiseStream);\n    throw new Error('not a promise-stream');\n  }\n}\n\n"],"names":[],"mappings":"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","debug_id":"83624b7c-063b-55be-8827-45e03306e857"}