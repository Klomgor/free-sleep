{"version":3,"file":"updateDeviceStatus.js","sources":["routes/deviceStatus/updateDeviceStatus.ts"],"sourceRoot":"/","sourcesContent":["import _ from 'lodash';\nimport { DeepPartial } from 'ts-essentials';\nimport cbor from 'cbor';\n\nimport { DeviceStatus, SideStatus } from './deviceStatusSchema.js';\nimport { executeFunction } from '../../8sleep/deviceApi.js';\nimport logger from '../../logger.js';\nimport settingsDB from '../../db/settings.js';\nimport memoryDB from '../../db/memoryDB.js';\nimport { INVERTED_SETTINGS_KEY_MAPPING } from '../../8sleep/loadDeviceStatus.js';\n\nconst calculateLevelFromF = (temperatureF: number) => {\n  const level = (temperatureF - 82.5) / 27.5 * 100;\n  return Math.round(level).toString();\n};\n\nconst updateSide = async (side: 'left' | 'right', sideStatus: DeepPartial<SideStatus>) => {\n  await settingsDB.read();\n  const settings = settingsDB.data;\n  if (side === 'left') {\n    if (settings.left.awayMode) {\n      throw new Error('Left side is in away mode, not updating side');\n    }\n  } else {\n    if (settings.right.awayMode) {\n      throw new Error('Right side is in away mode, not updating side');\n    }\n  }\n  const controlBothSides = settings.left.awayMode || settings.right.awayMode;\n  const updateLeft = side === 'left' || controlBothSides;\n  const updateRight = side === 'right' || controlBothSides;\n\n  const { isOn, targetTemperatureF, secondsRemaining, isAlarmVibrating } = sideStatus;\n\n  if (controlBothSides) {\n    logger.debug('One side is in away mode, updating both sides...');\n  }\n\n  if (isOn !== undefined) {\n    const onDuration = isOn ? '43200' : '0';\n    if (updateLeft) await executeFunction('LEFT_TEMP_DURATION', onDuration);\n    if (updateRight) await executeFunction('RIGHT_TEMP_DURATION', onDuration);\n  }\n\n  if (targetTemperatureF) {\n    const level = calculateLevelFromF(targetTemperatureF);\n    if (updateLeft) await executeFunction('TEMP_LEVEL_LEFT', level);\n    if (updateRight) await executeFunction('TEMP_LEVEL_RIGHT', level);\n  }\n\n  if (secondsRemaining) {\n    const seconds = Math.round(secondsRemaining).toString();\n    if (updateLeft) await executeFunction('LEFT_TEMP_DURATION', seconds);\n    if (updateRight) await executeFunction('RIGHT_TEMP_DURATION', seconds);\n  }\n\n  if (isAlarmVibrating !== undefined) {\n    logger.debug('Can only set isAlarmVibrating to false for now...');\n    if (!isAlarmVibrating) await executeFunction('ALARM_CLEAR', 'empty');\n    await memoryDB.read();\n    memoryDB.data[side].isAlarmVibrating = false;\n    await memoryDB.write();\n  }\n};\n\n\nconst updateSettings = async (settings: Partial<DeviceStatus['settings']>) => {\n  const renamedSettings = _.mapKeys(settings, (value, key) => INVERTED_SETTINGS_KEY_MAPPING[key] || key);\n  const encodedBuffer = cbor.encode(renamedSettings);\n  const hexString = encodedBuffer.toString('hex');\n  await executeFunction('SET_SETTINGS', hexString);\n};\n\nexport const updateDeviceStatus = async (deviceStatus: DeepPartial<DeviceStatus>) => {\n  logger.info(`Updating device status..`);\n\n  if (deviceStatus.isPriming) await executeFunction('PRIME');\n  if (deviceStatus?.left) await updateSide('left', deviceStatus.left);\n  if (deviceStatus?.right) await updateSide('right', deviceStatus.right);\n  if (deviceStatus?.settings) await updateSettings(deviceStatus.settings);\n  logger.info('Finished updating device status');\n};\n"],"names":[],"mappings":"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","debug_id":"b16edb3a-2372-5e54-b617-0d6c65b5b006"}